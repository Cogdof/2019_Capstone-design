<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8"></meta>
    <link rel="stylesheet" type="text/css" href="./css/chattingPage.css">
  </head>

  <body>
    <div class="backgroundDiv">
      <div class="headerDiv">
        <div class="logoDiv" />
        <p class="headerText">Skatch-based chat</p>
      </div>
      </div>

      <div class="containerDiv">
        배경
        <!--채팅로그-->
        <!-- <textarea id="chatLog" class="chat_Log" readonly></textarea> -->
        <div id="chatLog" class="chat_Log"style="overflow:scroll";>
          <!-- 채팅 메시지 영역 -->
          <!-- 텍스트 및 이미지가 올라감 -->

        </div>

        <div class="chatFormat" id="chat">
          <input id="name" class="name" type="text" value="이름" readonly>
          <input id="message" class="message" type="text" placeholder="메시지를 입력하세요.">
          <button class="chat" onclick="send()">전송</button>
          <a class="skatchStart" href ="/draw"></a>
        </div>
        <div id="box" class="box">

          <!-- <div class="draw">

            <canvas id="canvas" width="300px" height="300px"style="border: 1px solid black;"></canvas>
            <div class="buttons">
              <div class="send">send</div>
                <button id="trash_b"onclick="clearCanvas()">delete</button>
              <div class="cancel">cancel</div>
            </div>
          </div>
        </div> -->
        <div>

          <div class='image_container'>
            <img id ="recommend1" src="./css/photoPlus.png" onclick = "click_recommand('recommend1')" style="width: 100px; height : 100px; ">
          </div>
          <div class='image_container'>
            <img id ="recommend2" src="./css/photoPlus.png" onclick = "click_recommand('recommend2')" style="width: 100px; height : 100px;">
          </div>
          <div class='image_container'>
            <img id ="recommend3" src="./css/photoPlus.png" onclick = "click_recommand('recommend3')" style="width: 100px; height : 100px;">
          </div>

        </div>

        <div>
            <canvas id="cnvs" width="500" height="500" style="border: 1px solid black;"></canvas>
            <br/>
            <div>
              <button  onclick="sendImg()">send</button>
              <button id ="btnDel">delete</button>
            </div>
        </div>

      </div>

          <script src = "/socket.io/socket.io.js"></script>
          <script src="//code.jquery.com/jquery-1.11.1.js"></script>
          <script>

          function click_recommand(recommend_id){

            alert("xxxx")
            var cnvs = document.getElementById('cnvs');
            var img = document.getElementById(recommend_id);
            var ctx = cnvs.getContext('2d');
            ctx.drawImage(img, 10, 10);
          }

          </script>

          <script>
          var socket = io()

          /* 접속 되었을 때 실행 */
          socket.on('connect', function() {
          /* 이름을 입력받고 */
          // var name = prompt('반갑습니다!', '')

          /* 이름이 빈칸인 경우 */
          // if(!name) {
          //   name = '익명'
          // }
          var name = "익명"
          /* 서버에 새로운 유저가 왔다고 알림 */
          socket.emit('newUser', name)
          })

          /* 서버로부터 데이터 받은 경우 */
          socket.on('update', function(data) {


          var chat = document.getElementById('chatLog')
          var user_name = document.getElementById('name')
          var message = document.createElement('div')

          if(data.type == 'image'){

            var node =  document.createElement("IMG");
            node.setAttribute("src", data.buffer);
            node.setAttribute("width", "100");
            node.setAttribute("height", "100");
            console.log("dsdsdsd")

          }else{

            var node = document.createTextNode(`${data.name}: ${data.message}`)

          }

          var className = ''

          // 타입에 따라 적용할 클래스를 다르게 지정
          switch(data.type) {
            case 'image':
              className = 'other'
              break
            case 'message':
              className = 'other'
              break

            case 'connect':
              className = 'connect'
              break

            case 'disconnect':
              className = 'disconnect'
              break
          }

          message.classList.add(className)
          message.appendChild(node)
          chat.appendChild(message)

          })




          function sendImg() {
          // 입력되어있는 데이터 가져오기
          var image_canvas = document.getElementById('cnvs')
          var image =  cnvs.toDataURL()

          var x =  document.createElement("IMG");
          x.setAttribute("src", image);
          x.setAttribute("width", "150");
          x.setAttribute("height", "150");

          // 가져왔으니 데이터 빈칸으로 변경
          // 내가 전송할 메시지 클라이언트에게 표시
          var chat = document.getElementById('chatLog')
          var msg = document.createElement('div')

          msg.classList.add('me')
          msg.appendChild(x)
          chat.appendChild(msg)


          // 서버로 message 이벤트 전달 + 데이터와 함께
          socket.emit('image', { type: 'image',  buffer: image})
          }

          /* 메시지 전송 함수 */
          function send() {
          // 입력되어있는 데이터 가져오기
          var message = document.getElementById('message').value

          // 가져왔으니 데이터 빈칸으로 변경
          document.getElementById('message').value = ''

          // 내가 전송할 메시지 클라이언트에게 표시
          var chat = document.getElementById('chatLog')
          var msg = document.createElement('div')
          var node = document.createTextNode(message)
          msg.classList.add('me')
          msg.appendChild(node)
          chat.appendChild(msg)

          // 서버로 message 이벤트 전달 + 데이터와 함께
          socket.emit('message', {type: 'message', message: message})
          }

        </script>

        <script>

        $(document).ready(function(){
            // canvas
            var cnvs = document.getElementById('cnvs');
            // canvas 사용가능
            if (cnvs.getContext) {
                // 캔버스 컨텍스트
                var ctx = cnvs.getContext('2d');
                ctx.fillStyle = 'rgb(255, 255, 255)';
                ctx.fillRect(0, 0, cnvs.width, cnvs.height);
                // 그리기 모드인지 체크하는 변수
                var isDraw = false;

                // 그리기 옵션
                var dot = 2;
                var color = 'rgb(0, 0, 0)';

                // 그리기 옵션 - 도트크기
                $('#dot').bind('change', function(){  dot = $('#dot').val(); });
                // 그리기 옵션 - 색깔
                $('#color').bind('change', function(){ color = $('#color').val(); });

                // 이벤트 핸들러 연결
                $('#cnvs').mousemove(function(e){
                    // 그릴 수 있으면 그린다.
                    if (isDraw) draw(e);
                });
                $('#cnvs').mousedown(function(e){
                    // 왼쪽 버튼 down 이면 그릴 수 있다고 선언
                    if (e.button===0) {
                        isDraw = true;
                        draw(e);
                    }
                });
                $('#cnvs').mouseup(function(e){
                    // 버튼 up 이면 그릴 수 없다고 선언
                    // 지금 까지 그린 canvas data convert image data and send socket
                    isDraw = false;
                    // var imgDataTest = ctx.createImageData(cnvs.width, cnvs.height);
                    // var image = new Image();
                    // image.src = cnvs.toDataURL('image/png');
                    // var image = cnvs.toDataURL("image/png").replace("image/png", "image/octet-stream");
                    // window.location.href=image;
                    var image = cnvs.toDataURL("image/png")
                    image.download
                    // sendImg()

                });

                // 그리기
                function draw(e)
                {
                    ctx.fillStyle = color;
                    // ctx.fillRect(e.offsetX, e.offsetY, dot, dot);
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();

                }

                // 지우기
                function clearCanvas()
                {
                    ctx.clearRect(0, 0, cnvs.width, cnvs.height);
                    ctx.beginPath();

                    localStorage.removeItem('imgData');
                }
                $("#btnDel").click(function(){ clearCanvas()});

            // canvas 사용불가
            } else {
                alert('canvas가 지원되지 않는 브라우저입니다. 구글 크롬을 권장합니다.');
                return;
            }

        });
        </script>

  </body>

</html>
